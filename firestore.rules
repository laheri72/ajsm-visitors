rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Visitors
    match /visitors/{id} {
      allow read: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );

      allow update: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );

      allow create: if true;

      allow delete: if request.auth != null
        && request.auth.token.email == "admin@ajsm.edu";
    }

    // Cards
    match /cards/{cardId} {
      allow read: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );

      // Admin: full control
      allow update: if request.auth != null
        && request.auth.token.email == "admin@ajsm.edu";

      // Desk: LIMITED update (release only)
      allow update: if request.auth != null
        && request.auth.token.email == "desk@ajsm.edu"
        && request.resource.data.status == "available"
        && request.resource.data.assignedTo == null;

      allow create: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );

      allow delete: if false;
    }

    // Counters
    match /counters/{counterId} {
      allow read: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );

      allow update: if request.auth != null
        && (
          request.auth.token.email == "admin@ajsm.edu"
          || request.auth.token.email == "desk@ajsm.edu"
        );
    }
  }
}